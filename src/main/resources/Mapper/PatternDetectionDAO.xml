<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.PatternDetectionDAO">

    <!-- 모든 패턴 탐지 조회 -->
    <select id="getAllPatternDetections" resultType="com.example.demo.dto.PatternDetection">
        SELECT * FROM pattern_detection
    </select>

    <!-- 이름으로 패턴 탐지 조회 -->
    <select id="getPatternDetectionByName" resultType="com.example.demo.dto.PatternDetection" parameterType="java.lang.String">
        SELECT * FROM pattern_detection WHERE policy_name = #{name}
    </select>

    <!-- 패턴 탐지 추가 -->
    <insert id="addPatternDetection" parameterType="com.example.demo.dto.PatternDetection">
        INSERT INTO pattern_detection (detection_number, s_ip, d_ip, s_port, d_port, create_dt, modify_dt, action_type, policy_name, policy_info, pattern_1, pattern_2, pattern_3, dangerous, regexp_1, regexp_2, regexp_3)
        VALUES (#{detectionNumber}, #{sIp}, #{dIp}, #{sPort}, #{dPort}, #{createDt}, #{modifyDt}, #{actionType}, #{policyName}, #{policyInfo}, #{pattern1}, #{pattern2}, #{pattern3}, #{dangerous}, #{regexp1}, #{regexp2}, #{regexp3})
    </insert>

    <!-- 패턴 탐지 수정 -->
    <update id="updatePatternDetection" parameterType="com.example.demo.dto.PatternDetection">
        UPDATE pattern_detection
        SET s_ip = #{sIp}, d_ip = #{dIp}, s_port = #{sPort}, d_port = #{dPort}, create_dt = #{createDt}, modify_dt = #{modifyDt}, action_type = #{actionType},
            policy_name = #{policyName}, policy_info = #{policyInfo}, pattern_1 = #{pattern1}, pattern_2 = #{pattern2}, pattern_3 = #{pattern3}, dangerous = #{dangerous},
            regexp_1 = #{regexp1}, regexp_2 = #{regexp2}, regexp_3 = #{regexp3}
        WHERE detection_number = #{detectionNumber}
    </update>

    <!-- 패턴 탐지 삭제 -->
    <delete id="deletePatternDetection" parameterType="java.lang.Long">
        DELETE FROM pattern_detection WHERE detection_number = #{detectionNumber}
    </delete>

    <!-- 검색 조건으로 패턴 탐지 조회 -->
    <select id="searchPatternDetections" resultType="com.example.demo.dto.PatternDetection" parameterType="java.lang.String">
        SELECT * FROM pattern_detection WHERE pattern_1 LIKE '%' || #{searchInputName} || '%'
                                              OR pattern_2 LIKE '%' || #{searchInputName} || '%'
                                              OR pattern_3 LIKE '%' || #{searchInputName} || '%'
    </select>

    <!-- 페이징된 모든 패턴 탐지 조회 -->
    <select id="getAllPatternDetectionsPaged" resultType="com.example.demo.dto.PatternDetection" parameterType="java.util.Map">
        SELECT * FROM (
            SELECT ROW_NUMBER() OVER (ORDER BY detection_number) AS ROWNUM, pattern_detection.*
            FROM pattern_detection
        ) WHERE ROWNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 시간 범위로 패턴 탐지 조회 -->
    <select id="getPatternDetectionsByTimeRange" resultType="com.example.demo.dto.PatternDetection" parameterType="java.util.Map">
        SELECT * FROM pattern_detection
        WHERE create_dt BETWEEN #{start} AND #{end}
    </select>

</mapper>
