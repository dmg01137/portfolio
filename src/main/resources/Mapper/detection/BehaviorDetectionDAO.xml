<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.detection.BehaviorDetectionDAO">

    <!-- 모든 BehaviorDetection 조회 -->
    <select id="getAllBehaviorDetections" resultType="com.example.demo.dto.detection.BehaviorDetection">
        SELECT * FROM detection_db.behavior_detection
    </select>

    <!-- 이름으로 BehaviorDetection 조회 -->
    <select id="getBehaviorDetectionsByName" resultType="com.example.demo.dto.detection.BehaviorDetection" parameterType="java.lang.String">
        SELECT * FROM detection_db.behavior_detection WHERE policy_name = #{name}
    </select>

    <!-- BehaviorDetection 추가 -->
    <insert id="addBehaviorDetection" parameterType="com.example.demo.dto.detection.BehaviorDetection">
        INSERT INTO detection_db.behavior_detection (
            detection_number, s_ip, d_ip, s_port, d_port, create_dt, modify_dt, action_type, policy_name, policy_info,
            pattern_1, pattern_2, pattern_3, dangerous, regexp_1, regexp_2, regexp_3, base_cnt, base_time
        ) VALUES (
            #{detectionNumber}, #{sIp}, #{dIp}, #{sPort}, #{dPort}, #{createDt}, #{modifyDt}, #{actionType}, #{policyName}, #{policyInfo},
            #{pattern1}, #{pattern2}, #{pattern3}, #{dangerous}, #{regexp1}, #{regexp2}, #{regexp3}, #{baseCnt}, #{baseTime}
        )
    </insert>

    <!-- BehaviorDetection 수정 -->
    <update id="updateBehaviorDetection" parameterType="com.example.demo.dto.detection.BehaviorDetection">
        UPDATE detection_db.behavior_detection
        SET s_ip = #{sIp}, d_ip = #{dIp}, s_port = #{sPort}, d_port = #{dPort}, create_dt = #{createDt}, modify_dt = #{modifyDt},
            action_type = #{actionType}, policy_name = #{policyName}, policy_info = #{policyInfo}, pattern_1 = #{pattern1},
            pattern_2 = #{pattern2}, pattern_3 = #{pattern3}, dangerous = #{dangerous}, regexp_1 = #{regexp1},
            regexp_2 = #{regexp2}, regexp_3 = #{regexp3}, base_cnt = #{baseCnt}, base_time = #{baseTime}
        WHERE detection_number = #{detectionNumber}
    </update>

    <!-- BehaviorDetection 삭제 -->
    <delete id="deleteBehaviorDetection" parameterType="java.lang.Long">
        DELETE FROM detection_db.behavior_detection WHERE detection_number = #{detectionNumber}
    </delete>

    <!-- 검색 조건으로 BehaviorDetection 조회 -->
    <select id="searchBehaviorDetections" resultType="com.example.demo.dto.detection.BehaviorDetection" parameterType="com.example.demo.dto.detection.BehaviorDetection">
        SELECT * FROM detection_db.behavior_detection
        WHERE (pattern_1 LIKE CONCAT('%', #{pattern1}, '%') OR pattern_1 IS NULL)
           OR (pattern_2 LIKE CONCAT('%', #{pattern2}, '%') OR pattern_2 IS NULL)
           OR (pattern_3 LIKE CONCAT('%', #{pattern3}, '%') OR pattern_3 IS NULL)
    </select>

    <!-- 페이징된 모든 BehaviorDetection 조회 -->
    <select id="getAllBehaviorDetectionsPaged" resultType="com.example.demo.dto.detection.BehaviorDetection" parameterType="java.util.Map">
        SELECT * FROM (
            SELECT ROW_NUMBER() OVER (ORDER BY detection_number) AS ROWNUM, behavior_detection.*
            FROM detection_db.behavior_detection
        ) AS paged
        WHERE ROWNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 시간 범위로 BehaviorDetection 조회 -->
    <select id="getBehaviorDetectionsByTimeRange" resultType="com.example.demo.dto.detection.BehaviorDetection" parameterType="java.util.Map">
        SELECT * FROM detection_db.behavior_detection
        WHERE create_dt BETWEEN #{start} AND #{end}
    </select>

</mapper>
