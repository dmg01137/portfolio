<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.log.PatternLogDAO">

    <!-- 패턴 로그에 대한 결과 매핑 -->
    <resultMap id="patternLogResultMap"
                type="com.example.demo.dto.log.PatternLog">
        <id property="id" column="id" />
        <result property="time" column="time" />
        <result property="sIp" column="s_ip" />
        <result property="dIp" column="d_ip" />
        <result property="sPort" column="s_port" />
        <result property="dPort" column="d_port" />
        <result property="len" column="len" />
        <result property="pattern1" column="pattern1" />
        <result property="pattern2" column="pattern2" />
        <result property="pattern3" column="pattern3" />
        <result property="packet" column="packet" />
        <result property="actionType" column="action_type" />
    </resultMap>

    <!-- ID를 기반으로 패턴 로그를 조회합니다 -->
    <select id="findById" resultMap="patternLogResultMap"
            parameterType="int">
        SELECT * FROM log_db.pattern_log_20240716 WHERE id = #{id}
    </select>

    <!-- 모든 패턴 로그를 조회합니다 -->
    <select id="findAll" resultMap="patternLogResultMap">
         SELECT *
        FROM log_db.${tableName}
    </select>

  

    <!-- Top 5 s_ip 값 조회 -->
    <select id="findTopSIPs" resultType="java.util.Map">
        SELECT s_ip, COUNT(*) AS ip_count
        FROM log_db.${tableName}
        GROUP BY s_ip
        ORDER BY ip_count DESC
        LIMIT 5;
    </select>

    <!-- Top 3 패턴 조합 조회 -->
    <select id="findTopPatternCombinations"
            resultType="java.util.Map">
        SELECT CONCAT(pattern1, ',', pattern2, ',', pattern3) AS combined_pattern,
               COUNT(*) AS pattern_count
        FROM log_db.${tableName}
        GROUP BY combined_pattern
        ORDER BY pattern_count DESC
        LIMIT 3;
    </select>

    <!-- 모든 패턴 로그를 최신 순으로 조회 -->
    <select id="findAllOrderedByTimeDesc"
            resultMap="patternLogResultMap">
        SELECT *
        FROM log_db.${tableName}
        ORDER BY time DESC;
    </select>

    <!-- 다중 검색 기능을 위한 패턴 로그 조회 -->
<select id="findByMultipleCriteria" resultMap="patternLogResultMap" parameterType="map">
    SELECT *
    FROM log_db.${tableName}
    WHERE 1=1
    <!-- ID 검색 조건 -->
    <if test="criteria.id != null and criteria.ip != ''">
        AND id LIKE CONCAT('%', #{criteria.id}, '%')
    </if>
    <!-- 시간 검색 조건 -->
    <if test="criteria.time != null">
        AND time LIKE CONCAT('%', #{criteria.time}, '%')
    </if>
    <!-- 송신 IP 검색 조건 -->
    <if test="criteria.sIp != null">
        AND s_ip LIKE CONCAT('%',  #{criteria.sIp}, '%')
    </if>
    <!-- 수신 IP 검색 조건 -->
    <if test="criteria.dIp != null">
        AND d_ip LIKE CONCAT('%',  #{criteria.dIp}, '%')
    </if>
    <!-- 송신 포트 검색 조건 -->
    <if test="criteria.sPort != null">
        AND s_port LIKE CONCAT('%',  #{criteria.sPort}, '%')
    </if>
    <!-- 수신 포트 검색 조건 -->
    <if test="criteria.dPort != null">
        AND d_port LIKE CONCAT('%',  #{criteria.dPort}, '%')
    </if>
    <!-- 길이 검색 조건 -->
    <if test="criteria.len != null">
        AND len LIKE CONCAT('%',  #{criteria.len}, '%')
    </if>
    <!-- 패턴 1 검색 조건 -->
    <if test="criteria.pattern1 != null">
        AND pattern1 LIKE CONCAT('%',  #{criteria.pattern1}, '%')
    </if>
    <!-- 패턴 2 검색 조건 -->
    <if test="criteria.pattern2 != null">
        AND pattern2 LIKE CONCAT('%',  #{criteria.pattern2}, '%')
    </if>
    <!-- 패턴 3 검색 조건 -->
    <if test="criteria.pattern3 != null">
        AND pattern3 LIKE CONCAT('%',  #{criteria.pattern3}, '%')
    </if>
    <!-- 액션 타입 검색 조건 -->
    <if test="criteria.actionType != null">
        AND action_type LIKE CONCAT('%',  #{criteria.actionType}, '%')
    </if>
  
</select>


</mapper>