<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.log.BehaviorLogDAO">

    <resultMap id="behaviorLogResultMap" type="com.example.demo.dto.log.BehaviorLog">
        <id property="id" column="id" />
        <result property="time" column="time" />
        <result property="s_ip" column="s_ip" />
        <result property="d_ip" column="d_ip" />
        <result property="s_port" column="s_port" />
        <result property="d_port" column="d_port" />
        <result property="len" column="len" />
        <result property="policy_name" column="policy_name" />
        <result property="pattern1" column="pattern1" />
        <result property="pattern2" column="pattern2" />
        <result property="pattern3" column="pattern3" />
        <result property="packet" column="packet" />
        <result property="base_cnt" column="base_cnt" />
        <result property="base_time" column="base_time" />
        <result property="action_type" column="action_type" />
    </resultMap>

    <!-- ID로 조회 -->
    <select id="findById" resultType="com.example.demo.dto.log.BehaviorLog" parameterType="int">
        SELECT *
        FROM log_db.${tableName}
        WHERE id = #{id}
    </select>

    <!-- 모든 데이터 조회 -->
    <select id="findAll" resultType="com.example.demo.dto.log.BehaviorLog">
        SELECT *
        FROM log_db.${tableName}
    </select>

    <!-- 다중 검색 기능을 위한 패턴 로그 조회 -->
 <select id="findByMultipleCriteria" resultMap="behaviorLogResultMap" parameterType="map">
    <foreach collection="dates" item="date" separator=" UNION ">
        SELECT *
        FROM log_db.${tableName}
        WHERE 1=1
        <!-- Date 검색 조건 -->
        <if test="criteria.date != null and criteria.date != ''">
            AND date_format(time, '%Y%m%d') = #{criteria.date}
        </if>
   
        <!-- ID 검색 조건 -->
        <if test="criteria.id != null and criteria.id != ''">
            AND id LIKE CONCAT('%', #{criteria.id}, '%')
        </if>
        <!-- time 검색 조건 -->
        <if test="criteria.time != null and criteria.time != ''">
            AND time LIKE CONCAT('%', #{criteria.time}, '%')
        </if>
        <!-- 송신 IP 검색 조건 -->
        <if test="criteria.s_ip != null and criteria.s_ip != ''">
            AND s_ip LIKE CONCAT('%', #{criteria.s_ip}, '%')
        </if>
        <!-- 송신 포트 검색 조건 -->
        <if test="criteria.s_port != null">
            AND s_port LIKE CONCAT('%', #{criteria.s_port}, '%')
        </if>
        <!-- 수신 IP 검색 조건 -->
        <if test="criteria.d_ip != null and criteria.d_ip != ''">
            AND d_ip LIKE CONCAT('%', #{criteria.d_ip}, '%')
        </if>
        <!-- 수신 포트 검색 조건 -->
        <if test="criteria.d_port != null">
            AND d_port  LIKE CONCAT('%', #{criteria.d_port}, '%')
        </if>
        <!-- 길이 검색 조건 -->
        <if test="criteria.len != null">
            AND len  LIKE CONCAT('%', #{criteria.len}, '%')
        </if>
        <!-- 길이 검색 조건 -->
        <if test="criteria.policy_name != null">
            AND policy_name  LIKE CONCAT('%', #{criteria.policy_name}, '%')
        </if>
        <!-- 패턴 1 검색 조건 -->
        <if test="criteria.pattern1 != null and criteria.pattern1 != ''">
            AND pattern1 LIKE CONCAT('%', #{criteria.pattern1}, '%')
        </if>
        <!-- 패턴 2 검색 조건 -->
        <if test="criteria.pattern2 != null and criteria.pattern2 != ''">
            AND pattern2 LIKE CONCAT('%', #{criteria.pattern2}, '%')
        </if>
        <!-- 패턴 3 검색 조건 -->
        <if test="criteria.pattern3 != null and criteria.pattern3 != ''">
            AND pattern3 LIKE CONCAT('%', #{criteria.pattern3}, '%')
        </if>
        <!-- 패킷 검색 조건 -->
        <if test="criteria.packet != null and criteria.packet != ''">
            AND packet LIKE CONCAT('%', #{criteria.packet}, '%')
        </if>
        <!-- 기본 카운트 검색 조건 -->
        <if test="criteria.base_cnt != null">
            AND base_cnt  LIKE CONCAT('%', #{criteria.base_cnt}, '%')
        </if>
        <!-- 기본 시간 검색 조건 -->
        <if test="criteria.base_time != null and criteria.base_time != ''">
            AND base_time LIKE CONCAT('%', #{criteria.base_time}, '%')
        </if>
        <!-- 액션 타입 검색 조건 -->
        <if test="criteria.action_type != null and criteria.action_type != ''">
            AND action_type LIKE CONCAT('%', #{criteria.action_type}, '%')
        </if>
    </foreach>
</select>


    <!-- Top 5 s_ip 값 조회 -->
    <select id="findTopSIPs" resultType="java.util.Map">
        SELECT s_ip, COUNT(*) AS ip_count
        FROM log_db.${tableName}
        GROUP BY s_ip
        ORDER BY ip_count DESC
        LIMIT 5;
    </select>

</mapper>